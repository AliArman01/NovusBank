const express = require('express');
const app = express();
const redis = require('redis');
const redisClient = redis.createClient();
var plivo = require('plivo');

// Make call to the destination number with OTP.
app.get('/dispatch_otp/:number', function(req, res) {
    const number = (req.params.number);
    const code = Math.floor(100000 + Math.random() * 900000);

    var client = new plivo.Client(" MANJDLMTUXYZMZZJA5NT", "ZTkyOTAwODc0Njg1NDkwMmIyYjJhMDBhOGJhMTM0");
    var response = client.calls.create(
        "+14151234567", // from
        number, // to
        "https://twofa-answerurl.herokuapp.com/answer_url/" + code, // answer url
        {
            answerMethod: "GET",
        },
    )
    console.log(response)
    redisClient.set(`number:${number}:code`, code, 'EX', 60);
    res.send(JSON.stringify({
        'status': 'success',
        'message': 'verification initiated'
    }));
});

// Validate the OTP entered by the user.
app.get('/verify_otp/:number/:code', function(req, res) {
    const number = (req.params.number);
    const code = (req.params.code);
    redisClient.get(`number:${number}:code`, function(err, OriginalCode) {
        if (OriginalCode == code) {
            redisClient.del(`number:${number}:code`);
            res.send(JSON.stringify({
                'status': 'success',
                'message': 'codes match! number verified'
            }));
        } else if (OriginalCode != code) {
            res.send(JSON.stringify({
                'status': 'failure',
                'message': 'codes do not match! number not verified'
            }));
        } else {
            res.send(JSON.stringify({
                'status': 'failure',
                'message': 'number not found!'
            }));
        }
    });
});

app.listen(5000);



const nexmo = new Nexmo({
    apiKey: ' MANJDLMTUXYZMZZJA5NT',
    apiSecret: 'ZTkyOTAwODc0Njg1NDkwMmIyYjJhMDBhOGJhMTM0',
  }, {debug: true});
  
exports.getMessege = (req,res,next)=>{
  res.render('sms-page');
}

exports.postMessege = async (req,res,next) =>{
    try{

            nexmo.message.sendSms('NEXMO', req.body.toNumber,
             req.body.message,
              {type: 'unicode'},
               (err, responseData) => {
                if (responseData){
                    console.log(responseData);
                    res.send(responseData);
                }
            });
          }
    catch (error) {
        const status = error.statusCode || 500;
        res.status(status).json({ error: error.data })
      }
    
}


import { generateRandomSixDigitsNumber } from './randon-number';
import { redisClient } from './redis-client';
import { twilioClient } from './twillio-client';

app.post('/send-code', async (req, res) => {
  const recipientPhoneNumber = req.body.phoneNumber;
  const randomNumber = generateRandomSixDigitsNumber();

  const message = `Hello from Teco Blog! Your verification code is: ${randomNumber}`;

  await redisClient.set(recipientPhoneNumber, `${randomNumber}`, 'EX', 600);

  const response = await twilioClient.messages.create({
    from: process.env.TWILIO_PHONE_NUMBER,
    to: recipientPhoneNumber,
    body: message,
  });

  return res.json({ message: `Message sent with id: ${response.sid}` });
});





    //  const recipientPhoneNumber = req.body.phoneNumber;
    //  console.log(recipientPhoneNumber)
    // const randomNumber = generateRandomSixDigitsNumber();
    // const message = `Hello from Arman ! Your verification code is: ${randomNumber}`;
    // console.log("messege", message)

    // const response = await twilioClient.messages.create({
    //     from: recipientPhoneNumber,
    //     to: +917319977276,
    //     body: message,
    //   });
    // return res.json({ message: `Message sent with id: ${response.sid}` });  


    // twilioClient.messages
    //     .create({ body: "Hello from Twilio",
    //     from: +13602275105, 
    //     to: +917319977276
    //     })
    //     .then(message => console.log(message.sid));

        
        // const nexmo = new Nexmo({
        //   apiKey: 'a3c30cd3',
        //   apiSecret: 'cMq6CR5R0AtexPrM'
        // });
        // const otp = Math.floor(1000 + Math.random() * 9000); // Generate a 4-digit OTP
        // const mobileNumber = "+919265216270" ; // Replace with the actual mobile number
        // console.log("your otp is here",otp)
        // nexmo.message.sendSms(
        //   recipientPhoneNumber, // Replace with your virtual number
        //   mobileNumber,
        //   `Hello Sams This is Your OTP  ${otp}`,
        //   { type: 'unicode' },
        //   (err, responseData) => {
        //     if (err) {
        //       console.log(err);
        //     } else {
        //       console.dir(responseData);
        //     }
        //   }
        // );  


        const accountSid = 'AC6a13a2d1dff2515f25b47637aa4d76cd';
const authToken = 'bfdb14efba2da5f85f23b555a26f05eb';
const twilioClient = twilio(accountSid, authToken);

const generateRandomSixDigitsNumber = () => {
    const min = 100000;
    const max = 999999;
    return Math.floor(Math.random() * (max - min + 1) + min);
  };
